---
title: Farey Linked List
date: '2024-04-18'
slug: farey-linked-list

---



<p>In my <a href="/blog/2024/04/10/farey-numbers-and-linked-lists">last post</a> I talked about using Farey numbers as coordinates for linked list elements. Let’s actually do it.</p>
<!--more-->
<script src=" https://cdn.jsdelivr.net/npm/cytoscape@3.28.1/dist/cytoscape.min.js "></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/rxjs/7.8.1/rxjs.umd.min.js" integrity="sha512-D9LDs8YUUVa4V9Gl4Zb+xqRAc7RCzooR3+zzebgK2RMu/KU+dh90pbjEEMzPiSyRSGbSp9j1pZnrO4joGa5WEg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<style type="text/css">
p > code {
    padding: 0 5px;
    margin: 0 2px;
    line-height: 2em;
}

body {
    line-height: 3em !important;
}

.katex {
    font-size: 1.1em !important;
    /*line-height: 1.7em !important;*/
    padding: 0 .15em;
    white-space: nowrap;
}

.cy {
    height: 8em;
    display: block;
}
</style>
<script>
let newId = function(left, right) {
    return {
        numerator: left.numerator + right.numerator,
        denominator: left.denominator + right.denominator
    }
}
let id = (element) => `${element.numerator}\n${element.denominator}`;

let graphit = function(element, destination, label='data(id)', fitpadding=30) {
    let cy = cytoscape({
        container: document.getElementById(destination), // container to render in
        elements: [ ],
        style: [ // the stylesheet for the graph
            {
                selector: 'node',
                style: {
                    'background-color': '#666',
                    'label': label,
                    'text-valign': 'bottom',
                    'text-margin-y': '1em',
                    'text-wrap': 'wrap',
                    'font-family': 'Merriweather, serif',
                    'width': "2em",
                    'height': "2em",
                    'font-size': '1.5em'
                }
            },
            {
                selector: 'edge',
                style: {
                    'width': ".5em",
                    'line-color': '#ccc',
                    'target-arrow-color': '#ccc',
                    'target-arrow-shape': 'triangle',
                    'curve-style': 'bezier'
                }
            }
        ],
        //panningEnabled: false,
        //userPanningEnabled: false,
        boxSelectionEnabled: false,
        autoungrabify: true,
        autounselectify: true
    });

    let focus;

    let doLayout = function(animate = false, fit = false) {
        //cy.clearQueue();
        cy.nodes().sort(function(n1, n2) {
            var l = n1.data('sort').numerator * n2.data('sort').denominator;
            var r = n2.data('sort').numerator * n1.data('sort').denominator;
            return (l - r) < 0n ? -1 : 1;
        }).layout({ 
            name: "grid", 
            rows: 1,
            avoidOverlapPadding: 200, 
            fit: fit, 
            animate: animate, 
            animationDuration: 200,
            center: { eles: [ focus ] } 
        }).run();
        cy.animate({ fit: { eles: focus, padding: fitpadding, duration: 200 } }) 
    }

    cy.on('tap', 'edge', function(evt, pos) {
        cy.remove(evt.target);

        var lnode = evt.target._private.data.leftnode
        var newel = insert(lnode);

        var newnode = cy.add({ group: 'nodes', data: { id: id(newel), sort: newel }, position: pos ?? evt.position });
        focus = newnode;
        cy.add({ 
            group: 'edges', 
            data: { 
                id: id(newId(lnode, newel)),
                source: id(lnode),
                target: id(newel),
                leftnode: lnode
            }});
        cy.add({ 
            group: 'edges', 
            data: { 
                id: id(newId(newel, newel.next)),
                source: id(newel),
                target: id(newel.next),
                leftnode: newel
            }});

        doLayout(true, false);
    })

    let last = undefined;
    let current = element;
    do {
        cy.add({ group: 'nodes', data: { id: id(current), sort: current }});

        if (last) {
            cy.add({
                group: 'edges', 
                data: { 
                    id: id(newId(last, current)), 
                    source: id(last), 
                    target: id(current),
                    leftnode: last
                }
            })
        }
        last = current;
        current = current.next;
    } while(current)

    focus = cy.elements();
    doLayout(false, true);
    rxjs.fromEvent(window, "resize").pipe(rxjs.debounceTime(200)).subscribe(doLayout);
    return cy;
}

let makeList = () => ({
    numerator: 0n,
    denominator: 1n,
    next: {
        numerator: 1n,
        denominator: 1n,
        next: undefined
    }
});

let insert = function(element) {
    // my kingdom for a type system
    if (!element || !element.next) {
        throw ":(";
    }

    // make the new element
    let newEl = {
        // it needs a Farey number
        // to make a new Farey number from two existing Farey numbers, 
        // you sum their numerators and denominators.
        numerator: element.numerator + element.next.numerator,
        denominator: element.denominator + element.next.denominator,

        // it points to what element currently points to.
        next: element.next
    };
    
    // insert the new element into the list by making element point to it.
    element.next = newEl;

    // return the new element
    return newEl;
}

let list = makeList();
</script>
<p>In my <a href="/blog/2024/04/10/farey-numbers-and-linked-lists">last post</a> I talked about using Farey numbers as coordinates for linked list elements. Here’s what that looks like. Click a link to insert a new element into the list.</p>
<div id="the-list" class="cy">

</div>
<script>
lecy = graphit(list, "the-list");
</script>
